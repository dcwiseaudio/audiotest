<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WiseReader Audio (Fully Safe)</title>
  <style>
    :root{--brand:#4f8ef7;--bg:#f7f7fb;--card:#fff;--bd:#e9eef5;--tx:#222;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:10px 16px}
    h1{margin:0;font-size:22px;font-weight:900;text-align:center}
    main{max-width:900px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input{
      flex:1 1 280px; padding:14px 12px; font-size:22px; font-weight:800;
      border:2px solid #d5ddea;border-radius:12px
    }
    button{
      padding:12px 14px;border-radius:12px;border:1px solid #d5ddea;background:#fff;
      font-size:16px;font-weight:800;cursor:pointer
    }
    button:active{transform:translateY(1px)}
    .small{font-size:13px;color:#666;line-height:1.4}
    .status{margin-top:10px;font-size:14px;font-weight:700}
    .ok{color:#1b5e20}
    .bad{color:#c62828}
    .now{margin-top:12px;font-size:18px;font-weight:900;text-align:center;color:var(--brand)}
    .controls{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .controls button{min-width:110px}
    .rate{
      display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap;
      margin-top:10px;
    }
    select{padding:10px 12px;border-radius:10px;border:1px solid #d5ddea;font-weight:800}
    audio{width:100%; margin-top:10px}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ§ WiseReader v1 ì˜¤ë””ì˜¤ ì¬ìƒ (Fully í˜¸í™˜)</h1>
  </header>

  <main>
    <div class="card">
      <div class="row">
        <input id="qn" placeholder="QN ì…ë ¥ (ì˜ˆ: N2300)" autocapitalize="characters" />
        <button id="btnLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button id="btnPlay">ì¬ìƒ</button>
        <button id="btnStop">ì •ì§€</button>
      </div>

      <div class="small" style="margin-top:10px">
        âœ… Fullyì—ì„œ TTS ì˜¤ë¥˜(speechSynthesis) ì—†ì´ ì‘ë™í•˜ë„ë¡ <b>mp3 íŒŒì¼</b>ì„ ì¬ìƒí•©ë‹ˆë‹¤.<br/>
        íŒŒì¼ ê·œì¹™: <b>audio/ì±…ì½”ë“œ.mp3</b> (ì˜ˆ: audio/n2300.mp3)
      </div>

      <div id="status" class="status"></div>
      <div id="now" class="now"></div>

      <audio id="player" controls preload="none"></audio>

      <div class="rate">
        <span style="font-weight:800;">ì¬ìƒì†ë„</span>
        <select id="rateSel">
          <option value="0.85">0.85x</option>
          <option value="0.9">0.9x</option>
          <option value="1.0" selected>1.0x</option>
          <option value="1.1">1.1x</option>
        </select>
        <span class="small">(*ì†ë„ëŠ” ê¸°ê¸°ë§ˆë‹¤ ë¯¸ì„¸ì°¨ì´ ìˆì„ ìˆ˜ ìˆì–´ìš”)</span>
      </div>

      <div class="controls">
        <button id="back2">âª -2ì´ˆ</button>
        <button id="fwd2">â© +2ì´ˆ</button>
        <button id="restart">ğŸ” ì²˜ìŒë¶€í„°</button>
      </div>
    </div>
  </main>

  <script>
    const $ = (id)=>document.getElementById(id);
    const qnInput = $('qn');
    const audio = $('player');
    const statusEl = $('status');
    const nowEl = $('now');
    const rateSel = $('rateSel');

    function normQN(raw){
      return (raw||'').trim().toLowerCase();
    }

    function setStatus(msg, ok=true){
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (ok ? 'ok' : 'bad');
    }

    function buildUrl(qn){
      // âœ… ìºì‹œ ë¬¸ì œ ë°©ì§€ìš© ì¿¼ë¦¬(ë§¤ë²ˆ ìµœì‹  íŒŒì¼ë¡œ)
      const cacheBust = Date.now();
      return `audio/${qn}.mp3?v=${cacheBust}`;
    }

    async function checkHead(url){
      // Fully/ì„œë²„ì— ë”°ë¼ HEADê°€ ë§‰í ìˆ˜ ìˆì–´ GETìœ¼ë¡œ fallback
      try{
        const r = await fetch(url, { method:'HEAD', cache:'no-store' });
        return r.ok;
      }catch(_){
        try{
          const r = await fetch(url, { method:'GET', cache:'no-store' });
          return r.ok;
        }catch(__){
          return false;
        }
      }
    }

    async function loadQN(){
      const qn = normQN(qnInput.value);
      if(!qn){ setStatus('QNì„ ì…ë ¥í•˜ì„¸ìš”.', false); return; }

      const url = buildUrl(qn);
      setStatus('íŒŒì¼ í™•ì¸ ì¤‘...', true);

      const ok = await checkHead(url);
      if(!ok){
        setStatus(`mp3ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: audio/${qn}.mp3`, false);
        nowEl.textContent = '';
        return;
      }

      audio.src = url;
      audio.playbackRate = parseFloat(rateSel.value || '1.0');
      audio.load();

      nowEl.textContent = `í˜„ì¬ ì±…ì½”ë“œ: ${qn.toUpperCase()}`;
      setStatus(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ âœ… (audio/${qn}.mp3)`, true);
    }

    function play(){
      if(!audio.src){ setStatus('ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ í•˜ì„¸ìš”.', false); return; }
      audio.playbackRate = parseFloat(rateSel.value || '1.0');
      audio.play().catch(()=>setStatus('ì¬ìƒì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í™”ë©´ í„°ì¹˜ í›„ ë‹¤ì‹œ ì¬ìƒí•´ ì£¼ì„¸ìš”.', false));
    }

    function stop(){
      audio.pause();
      audio.currentTime = 0;
      setStatus('ì •ì§€', true);
    }

    function jump(sec){
      if(!audio.duration) return;
      audio.currentTime = Math.min(Math.max(0, audio.currentTime + sec), audio.duration);
    }

    $('btnLoad').addEventListener('click', loadQN);
    $('btnPlay').addEventListener('click', play);
    $('btnStop').addEventListener('click', stop);

    $('back2').addEventListener('click', ()=>jump(-2));
    $('fwd2').addEventListener('click', ()=>jump(2));
    $('restart').addEventListener('click', ()=>{ audio.currentTime = 0; play(); });

    rateSel.addEventListener('change', ()=>{
      audio.playbackRate = parseFloat(rateSel.value || '1.0');
      setStatus(`ì¬ìƒì†ë„: ${audio.playbackRate}x`, true);
    });

    // Enterë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
    qnInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') loadQN();
    });
  </script>
</body>
</html>
